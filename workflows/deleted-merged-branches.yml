name: Delete Merged Branches

on:
  workflow_call:

jobs:
  delete-merged-branches:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete merged branch
        run: |
          # Get branch name and target branch
          BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          TARGET_BRANCH=${{ github.event.pull_request.base.ref }}

          # Check if merge was to master/qa branches and the branch is not protected
          if [[ "$TARGET_BRANCH" =~ ^(master|main|qa|QA)$ ]]; then
            if [[ ! "$BRANCH_NAME" =~ ^(master|main|qa|QA)$ ]]; then
              echo "Merged to $TARGET_BRANCH. Deleting branch $BRANCH_NAME"
              
              # Configure git
              git config --global user.name "github-actions"
              git config --global user.email "github-actions@github.com"

              # Delete the remote branch
              git push origin --delete "$BRANCH_NAME"
            else
              echo "Branch $BRANCH_NAME is protected, skipping deletion"
            fi
          else
            echo "Target branch is not master/qa/QA, skipping deletion"
          fi
